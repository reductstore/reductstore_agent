#!/usr/bin/env bash
set -euo pipefail

if [ -t 2 ]; then
  RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; NC='\033[0m'
else
  RED=''; GREEN=''; YELLOW=''; NC=''
fi
info()  { printf "%bINFO%b  %s\n"  "$GREEN" "$NC" "$*" >&2; }
warn()  { printf "%bWARN%b  %s\n"  "$YELLOW" "$NC" "$*" >&2; }
error() { printf "%bERROR%b %s\n" "$RED" "$NC" "$*" >&2; }

CONFIG_NAME="params.yml"
DEFAULT_CONFIG="$SNAP/share/reductstore_agent/config/$CONFIG_NAME"
SYSTEM_CONFIG="$SNAP_COMMON/$CONFIG_NAME"
COS_CONFIG="$SNAP_COMMON/configuration/$CONFIG_NAME"

mkdir -p "$SNAP_COMMON" "$SNAP_COMMON/configuration"

if [ ! -f "$DEFAULT_CONFIG" ]; then
  error "Bundled sample missing: $DEFAULT_CONFIG"
  exit 1
fi

if [ -f "$COS_CONFIG" ]; then
  info "COS config detected: $COS_CONFIG"
elif [ -f "$SYSTEM_CONFIG" ]; then
  info "System config already exists: $SYSTEM_CONFIG"
else
  cp "$DEFAULT_CONFIG" "$SYSTEM_CONFIG"
  chmod 0644 "$SYSTEM_CONFIG"
  info "Seeded system config: $SYSTEM_CONFIG"
fi

snapctl set replayer.enabled=false
info "Replayer disabled by default"

info "Install hook complete"
