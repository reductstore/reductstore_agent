#!/usr/bin/env bash
set -euo pipefail

# ---------- Logging helpers ----------
if [ -t 1 ]; then
  GREEN='\033[0;32m'; YELLOW='\033[1;33m'; RED='\033[0;31m'; NC='\033[0m'
else
  GREEN=''; YELLOW=''; RED=''; NC=''
fi
log_info()  { printf "%b[INFO]%b %s\n"  "$GREEN" "$NC" "$*"; }
log_warn()  { printf "%b[WARN]%b %s\n"  "$YELLOW" "$NC" "$*"; }
log_error() { printf "%b[ERROR]%b %s\n" "$RED" "$NC" "$*"; }

# ---------- Paths ----------
CONFIG_BASENAME="params.yml"
DEFAULT_CONFIG="$SNAP/share/reductstore_agent/config/$CONFIG_BASENAME"
USER_CONFIG="$SNAP_USER_COMMON/$CONFIG_BASENAME"
SYSTEM_CONFIG="$SNAP_COMMON/$CONFIG_BASENAME"
COS_CONFIG="$SNAP_COMMON/configuration/$CONFIG_BASENAME"

# ---------- Ensure dirs ----------
install -d -m 0755 "$SNAP_COMMON"
install -d -m 0755 "$SNAP_COMMON/configuration"

# ---------- Check bundled sample ----------
if [ ! -f "$DEFAULT_CONFIG" ]; then
  log_error "Sample config missing at $DEFAULT_CONFIG (packaging error)"
  exit 1
fi

# ---------- Decide which config to use/seed ----------
if [ -f "$COS_CONFIG" ]; then
  log_info "COS-provided config detected: $COS_CONFIG"
elif [ -f "$USER_CONFIG" ]; then
  log_info "User config already present: $USER_CONFIG"
elif [ -f "$SYSTEM_CONFIG" ]; then
  log_info "System config already present: $SYSTEM_CONFIG"
else
  install -D -m 0644 "$DEFAULT_CONFIG" "$SYSTEM_CONFIG"
  log_info "Seeded sample config â†’ $SYSTEM_CONFIG"
  log_info "Edit this file or create $USER_CONFIG to override."
fi

# ---------- Epilogue ----------
cat <<'EOF'

ReductStore Agent installation complete.
----------------------------------------

Configuration files:
  - COS config (if connected): $SNAP_COMMON/configuration/params.yml
  - User config (preferred):   $SNAP_USER_COMMON/params.yml
  - System config:             $SNAP_COMMON/params.yml

Bundled sample was copied to system config if none existed.

Run the agent:
  reductstore-agent.recorder

Get config help:
  reductstore-agent.config-help

EOF
